<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTFlex Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        body {
            background: #0f172a;
            color: #f8fafc;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-xl w-full space-y-6">
        <div class="text-center space-y-2">
            <h1 class="text-4xl font-bold tracking-tight text-indigo-400">YTFlex</h1>
            <p class="text-slate-400">Enter a YouTube URL to get started</p>
        </div>

        <div class="glass border border-slate-700 p-6 rounded-2xl shadow-2xl">
            <div class="space-y-4">
                <div>
                    <input type="text" id="urlInput" placeholder="https://www.youtube.com/watch?v=..."
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                </div>

                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Type</label>
                        <select id="typeSelect"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 outline-none">
                            <option value="video">Video</option>
                            <option value="audio">Audio Only</option>
                        </select>
                    </div>
                    <div id="resContainer" class="flex-1 min-w-[120px]">
                        <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Resolution</label>
                        <select id="resSelect"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 outline-none">
                            <option value="2160">2160p (4K)</option>
                            <option value="1440">1440p</option>
                            <option value="1080" selected>1080p</option>
                            <option value="720">720p</option>
                            <option value="480">480p</option>
                            <option value="360">360p</option>
                        </select>
                    </div>
                    <div id="formatContainer" class="flex items-end pb-2">
                        <label class="flex items-center cursor-pointer gap-2">
                            <input type="checkbox" id="mp4Check" class="w-4 h-4 accent-indigo-500">
                            <span class="text-sm text-slate-300">Force MP4</span>
                        </label>
                    </div>
                </div>

                <button onclick="handleFetch()" id="dlBtn"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="search"></i> Fetch Download
                </button>
            </div>
        </div>

        <div id="resultCard"
            class="hidden glass border border-indigo-500/30 p-5 rounded-2xl animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="flex flex-col sm:flex-row gap-4">
                <img id="thumb" src="" alt="Thumbnail" class="w-full sm:w-32 h-20 object-cover rounded-lg bg-slate-800">
                <div class="flex-1 min-w-0 flex flex-col justify-between">
                    <div>
                        <h3 id="videoTitle" class="font-bold truncate text-lg">Title</h3>
                        <p id="videoMeta" class="text-sm text-slate-400">0:00 • .webm • 0 MB</p>
                    </div>

                    <a id="finalDlLink" href="#" target="_blank"
                        class="mt-3 w-full bg-green-600 hover:bg-green-500 text-white text-center font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Download File
                    </a>
                </div>
            </div>
        </div>

        <div class="flex justify-end mb-2">
            <div id="apiStatus"
                class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-700">
                <div id="statusDot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                <span id="statusText" class="text-xs font-mono text-slate-400">CHECKING API...</span>
            </div>
        </div>

        <p id="statusMsg" class="text-center text-sm text-slate-500"></p>
    </div>

    <script>
        lucide.createIcons();

        const typeSelect = document.getElementById('typeSelect');
        const resContainer = document.getElementById('resContainer');
        const formatContainer = document.getElementById('formatContainer');

        typeSelect.addEventListener('change', (e) => {
            const isVideo = e.target.value === 'video';
            resContainer.classList.toggle('hidden', !isVideo);
            formatContainer.classList.toggle('hidden', !isVideo);
        });

        async function handleFetch() {
            const btn = document.getElementById('dlBtn');
            const status = document.getElementById('statusMsg');
            const resultCard = document.getElementById('resultCard');
            const link = document.getElementById('urlInput').value;

            if (!link) return alert("Please paste a link first!");

            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin mr-2">◌</span> Searching...`;
            status.innerText = "Talking to server, this might take a moment...";
            resultCard.classList.add('hidden');

            const type = typeSelect.value;
            const res = document.getElementById('resSelect').value;
            const mp4 = document.getElementById('mp4Check').checked;

            const baseUrl = `https://smelf.duckdns.org/ytflex/download/${type}`;
            const params = new URLSearchParams({ link });
            if (type === 'video') {
                params.append('res', res);
                params.append('mp4', mp4);
            }

            try {
                const response = await fetch(`${baseUrl}?${params.toString()}`);
                const data = await response.json();
                const info = data[0][0];

                if (info && info.link) {
                    document.getElementById('thumb').src = info.metadata.thumbnail;
                    document.getElementById('videoTitle').innerText = info.metadata.title;

                    // Added File Size to the metadata string
                    const size = info.metadata.filesize || 'Unknown size';
                    document.getElementById('videoMeta').innerText = `${info.metadata.duration} • ${info.metadata.extension} • ${size}`;

                    const dlLink = document.getElementById('finalDlLink');
                    dlLink.href = info.link;
                    // Set download attribute to suggest filename
                    dlLink.setAttribute('download', `${info.metadata.title}.${info.metadata.extension}`);

                    resultCard.classList.remove('hidden');
                    status.innerText = "Ready to download!";
                }
            } catch (err) {
                status.innerText = "Error: Could not reach the server.";
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="search"></i> Fetch Download`;
                lucide.createIcons();
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const baseUrl = "https://smelf.duckdns.org/ytflex";

            try {
                const response = await fetch(`${baseUrl}/root`);
                if (response.ok) {
                    dot.classList.replace('bg-yellow-500', 'bg-green-500');
                    dot.classList.remove('animate-pulse');
                    text.innerText = "API ONLINE";
                    text.classList.replace('text-slate-400', 'text-green-400');
                } else {
                    throw new Error();
                }
            } catch (err) {
                dot.classList.replace('bg-yellow-500', 'bg-red-500');
                dot.classList.remove('animate-pulse');
                text.innerText = "API OFFLINE";
                text.classList.replace('text-slate-400', 'text-red-400');
            }
        });
    </script>
</body>

</html>